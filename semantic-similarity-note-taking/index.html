<!DOCTYPE html>
<html>
<head>
  <title>Semantic Similarity for Note Taking | Boris Smus</title>

  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0' />

  <meta name="description" content="Days after capturing a "new" insight, it can be humbling to realize that you are repeating yourself. This might not be a bad thing, as you mull over a complex idea in its various forms over the course of many weeks. But what if your note taking app could act as a co-pilot? It could surface similar notes that are relevant to your current writing, and if you use such a system for long enough, help you synthesize across your own thinking over many years. You might want to link to the semantically related note, or to merge with it entirely. Building on  a previous technique , I implemented this idea as an Obsidian plugin:" />
  <meta name="author" content="Boris Smus" />
  <link rel="canonical" href="https://smus.com/semantic-similarity-note-taking/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Semantic Similarity for Note Taking" />
  <meta name="twitter:description" content="Days after capturing a "new" insight, it can be humbling to realize that you are repeating yourself. This might not be a bad thing, as you mull over a complex idea in its various forms over the course of many weeks. But what if your note taking app could act as a co-pilot? It could surface similar notes that are relevant to your current writing, and if you use such a system for long enough, help you synthesize across your own thinking over many years. You might want to link to the semantically related note, or to merge with it entirely. Building on  a previous technique , I implemented this idea as an Obsidian plugin:" />

  <!-- Facebook -->
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://smus.com/semantic-similarity-note-taking/" />
  <meta property="og:title" content="Semantic Similarity for Note Taking" />
  <meta property="og:description" content="Days after capturing a "new" insight, it can be humbling to realize that you are repeating yourself. This might not be a bad thing, as you mull over a complex idea in its various forms over the course of many weeks. But what if your note taking app could act as a co-pilot? It could surface similar notes that are relevant to your current writing, and if you use such a system for long enough, help you synthesize across your own thinking over many years. You might want to link to the semantically related note, or to merge with it entirely. Building on  a previous technique , I implemented this idea as an Obsidian plugin:" />

  <!-- Coil monetization experiment: https://coil.com/settings/monetize -->
  <meta name="monetization" content="$ilp.uphold.com/4Fnyw8KLaPZG">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
  <link rel="manifest" href="/static/icons/site.webmanifest">

  <!-- Styles -->
  <link
  href='//fonts.googleapis.com/css?family=Roboto+Condensed:300|Open+Sans+Condensed:700|Source+Serif+Pro:400,700|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel='stylesheet' href='/static/css/style.css'>
  <link rel='stylesheet' href='/static/css/syntax-highlight.css'>

  <!-- Feed -->
  <link href="https://smus.com/atom.xml" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
<header>
  <div id='title'>
    <h1><a href='/'>Boris Smus</a></h1>
    <h2>interaction engineering</h2>
  </div>
  <nav role='navigation'>
    <a href='/about/' >About</a>
    <a href='/blog/' >Blog</a>
    <a href='/clippings/' >Clippings</a>
  </nav>
</header>

<section id='main'>
  <article>
    <a href='/semantic-similarity-note-taking'><h1 class='title'>Semantic Similarity for Note Taking</h1></a>
    <div class='body'>
      <p>Days after capturing a "new" insight, it can be humbling to realize that you are
repeating yourself. This might not be a bad thing, as you mull over a complex
idea in its various forms over the course of many weeks. But what if your note
taking app could act as a co-pilot? It could surface similar notes that are
relevant to your current writing, and if you use such a system for long enough,
help you synthesize across your own thinking over many years. You might want to
link to the semantically related note, or to merge with it entirely. Building on
<a href="/ai-note-garden-linker">a previous technique</a>, I implemented this idea as an
Obsidian plugin:</p>

<iframe width="560" height="360" src="https://www.youtube.com/embed/kZkDCjr8ZqU?controls=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<!--more-->

<p>I'm pleased with the result. It's nice to feel like my note taking software is
actively trying to help me reconnect with past selves. Whether this ultimately
proves to be useful remains to be seen, but it works well enough that I plan to
run this as a self-experiment over the next few months.</p>

<p>My <a href="/ai-note-garden-linker">first stab</a> at this problem generated a list of
related notes across the whole corpus using semantic similarity. But my
implementation had two fundamental limitations:</p>

<ol>
<li><strong>Time</strong>: My script ran at night, so that there was long delay between
repeating myself and learning about this fact.</li>
<li><strong>Space</strong>: It generated a list of similar notes in a separate text file which
I would rarely consult.</li>
</ol>

<p>By building this as an Obsidian plugin, I addressed both fundamental problems in
the time and the space continuum!</p>

<ol>
<li>The current paragraph is continuously fed into a semantic similarity model,
so that movement of the cursor or textual edits trigger updates in
real-time.</li>
<li>Similar excerpts are presented in a dedicated sidebar, allowing you to
see related notes and excerpts right away.</li>
</ol>

<h1>How is this implemented?</h1>

<p>The current implementation has two parts:</p>

<ol>
<li><strong>Indexer</strong> is a script that runs nightly, generating per-paragraph
embeddings for each note in the corpus. These embeddings and other metadata
are then saved as JSON.</li>
<li><strong>Obsidian plugin</strong> generates embeddings for any text within Obsidian, and
then compares the result to the pre-generated embeddings.</li>
</ol>

<p>Both plugins use exactly the same embedding model to guarantee that the
embedding mappings are identical. The one running inside Obsidian must use
JavaScript, and I've already been using <a href="https://github.com/tensorflow/tfjs-models/tree/master/universal-sentence-encoder">Universal Sentence Encoder
lite</a>
for <a href="https://github.com/google-research/usnea">other projects</a>. For simplicity
and to guarantee identical outputs, I built the indexer using the same exact
model, running in node.js using tfjs-node. My previous python implementation of
this used a <a href="https://tfhub.dev/google/universal-sentence-encoder-large/">slightly larger model of
USE</a>.</p>

<p>The plugin works as follows:</p>

<ol>
<li>Find the currently active text: if there's an active editor, find the
paragraph at the current cursor position. If there's a selection, use the
selected text.</li>
<li>Extract its semantic similarity embedding, which in the case of USE is a
512-dimensional vector.</li>
<li>Compare its embedding to the rest of the embeddings for every other excerpt
in the corpus, which is saved as an Nx512 matrix. Comparison here is a matrix
multiplication, the result of which is a vector of scores corresponding to
the similarity of the source excerpt with each of the N excerpt.</li>
<li>Find the top K scores and their corresponding excerpt.</li>
<li>Display the resulting notes and excerpts.</li>
</ol>

<h1>Running this in a web worker</h1>

<p>Doing the above steps takes time. On my laptop it takes a second to generate
embeddings, and another half second to do the multiplication and ranking. This
will of course vary depending on your hardware and note corpus size. But even in
my relatively favorable conditions, the resulting latency of a couple seconds is
far too long to be doing this kind of work on the UI thread, which is the
default behavior of tf.js in the Electron environment of the Obsidian plugin. I
sought and found a workaround, which is to run <a href="https://erdem.pl/2020/02/making-tensorflow-js-work-faster-with-web-workers">tf.js in a web
worker</a>,
in CPU mode. This slows execution by about 50%, but is totally worth it to make
the plugin usable in real life.</p>

<h1>Toward standalone indexing</h1>

<p>I'd love for the plugin to run standalone without the need for a separate
indexer. This would allow others to use it far more easily without requiring
them to setup a whole indexing <a href="/file-systems-for-thought/">system</a>.</p>

<p>Implementing indexing within the plugin, I ran into memory issues computing
embeddings for my whole corpus. I haven't yet found the time to dig in to why
this was not a problem for the tfjs-node implementation of the indexer.</p>

<p>Before I seek workarounds, I want to live with the experience first. Is the
plugin useful for navigating my note corpus? Do the excerpts it surfaces make
sense as I'm writing a new note? Is the constantly changing semantic sidebar too
distracting? Let's find out; ƒor science!</p>

    </div>
    <div class='subfooter'>
      <div class='tombstone'>▪</div>
      <time class='published'>October 13, 2022</time>
    </div>
  </article>
</section>


<footer>
  <div>
    © Copyright 2005–2022 Boris Smus.
  </div>
  <nav role="footer">
    <a href='https://smus.com/atom.xml'>RSS</a>

    <!-- Mastodon verification -->
    <a rel="me" href="https://mastodon.social/@borismus" style="display: none">Mastodon</a>
  </nav>
</footer>

<!-- Misc scripts: syntax highlighting, analytics, stats. -->
<script src="/static/js/highlight.pack.js"></script>
<script>
  // Syntax highlighting for code.
  hljs.tabReplace = '  ';
  hljs.initHighlightingOnLoad();
</script>
<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-17930798-22', 'smus.com');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
<script src="/lightning_error.js"></script>

</body>
</html>