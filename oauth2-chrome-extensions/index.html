<!DOCTYPE html>
<html>
<head>
  <title>OAuth 2.0 from chrome extensions | Boris Smus</title>

  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0' />

  <meta name="description" content="A JavaScript library that handles OAuth 2.0 for you, with a dead simple API. Comes with adapters for Google, Facebook and Github." />
  <meta name="author" content="Boris Smus" />
  <link rel="canonical" href="https://smus.com/oauth2-chrome-extensions/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="OAuth 2.0 from chrome extensions" />
  <meta name="twitter:description" content="A JavaScript library that handles OAuth 2.0 for you, with a dead simple API. Comes with adapters for Google, Facebook and Github." />

  <!-- Facebook -->
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://smus.com/oauth2-chrome-extensions/" />
  <meta property="og:title" content="OAuth 2.0 from chrome extensions" />
  <meta property="og:description" content="A JavaScript library that handles OAuth 2.0 for you, with a dead simple API. Comes with adapters for Google, Facebook and Github." />

  <!-- Mastodon -->
  <link rel="me" href="https://mastodon.social/@borismus">

  <!-- Coil monetization experiment: https://coil.com/settings/monetize -->
  <meta name="monetization" content="$ilp.uphold.com/4Fnyw8KLaPZG">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
  <link rel="manifest" href="/static/icons/site.webmanifest">

  <!-- Styles -->
  <link
  href='//fonts.googleapis.com/css?family=Roboto+Condensed:300|Open+Sans+Condensed:700|Source+Serif+Pro:400,700|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel='stylesheet' href='/static/css/style.css'>
  <link rel='stylesheet' href='/static/css/syntax-highlight.css'>

  <!-- Feed -->
  <link href="https://smus.com/atom.xml" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
<header>
  <div id='title'>
    <h1><a href='/'>Boris Smus</a></h1>
    <h2>interaction engineering</h2>
  </div>
  <nav role='navigation'>
    <a href='/about/' >About</a>
    <a href='/blog/' >Blog</a>
    <a href='/projects/' >Projects</a>
  </nav>
</header>

<section id='main'>
  <article>
    <a href='/oauth2-chrome-extensions'><h1 class='title'>OAuth 2.0 from chrome extensions</h1></a>
    <div class='body'>
      <p>Applications that access online services often need to access a user's private
data. Chrome Extensions are no different. OAuth has emerged as the standard way
of letting users share their private resources across sites without having to
hand out their usernames and passwords. There is already a very nice 
<a href="http://code.google.com/chrome/extensions/tut_oauth.html">OAuth library for Chrome Extensions</a> that aims to simplify some of 
the pains that developers face when authorizing against OAuth endpoints.</p>

<p>Since this library was written, the OAuth standard enjoyed a version bump
(<a href="http://oauth.net/2/">OAuth 2.0</a>) which greatly simplifies the flow by no longer requiring
cryptography in the client. Also, some adventurous companies (notably
Google, Facebook and others) have actually implemented OAuth 2.0
endpoints. At the time of writing, OAuth 2.0 is still a draft spec, but is
nearing completion, and Chrome Extensions need some love.</p>

<p>You may be wondering why you even need an OAuth 2.0 library in the first place.
As Aaron Parecki pointed out in his <a href="http://www.slideshare.net/aaronpk/the-current-state-of-oauth-2">Current State of OAuth 2</a>
presentation at <a href="http://opensourcebridge.org/">Open Source Bridge</a> in Portland, OAuth 2 is very
much a moving target. The spec is not yet finalized, and there are 16 versions
of it (although the most popular seems to be v10). Also, today's OAuth 2
implementations diverge from the spec in varying degrees, adding to the
developer pain. The reason this library needs to be chrome extension-specific
is that unfortunately Chrome extensions can't directly use the OAuth 2.0
server-side or client-side flows because they live at <code>chrome-extension://</code>
URLs.</p>

<p>When writing the OAuth 2.0 library for Chrome extensions, I had some goals in
mind:</p>

<ol>
<li>Support a variety of OAuth 2.0 providers that implement the spec</li>
<li>Allow one app/extension to use multiple different OAuth 2.0 endpoints</li>
<li>Avoid background pages for performance reasons</li>
</ol>

<h2>The OAuth 2.0 Library</h2>

<p>There's a bit of setup involved if you'd like to create a Chrome extension that
connects to an OAuth 2 endpoint. This brief tutorial will guide you through
connecting to Google's APIs.</p>

<p>Register your application with an OAuth 2.0 endpoint that you'd like to
use. If it's a Google API you're calling, go to the <a href="https://code.google.com/apis/console/">Google APIs</a> page,
create your application and note your client ID and client secret. For more
info on this, check out the <a href="http://code.google.com/apis/accounts/docs/OAuth2.html">Google OAuth 2.0</a> docs. When you setup your
application, you will be asked to provide redirect URI(s). Please provide the
URI that corresponds to the service you're using.</p>

<p>Here's a table that will come in handy:</p>

<style>
  #impls { margin-left: -100px; }
  #impls td, #impls th { border: 1px solid #999 }
  #impls td { padding: 5px }
</style>

<table id="impls">
  <tr>
    <th>Adapter</th>
    <th>Redirect URI</th>
    <th>Access Token URI</th>
  </tr>
  <tr>
    <td>google</td>
    <td>http://www.google.com/robots.txt</td>
    <td>https://accounts.google.com/o/oauth2/token</td>
  </tr>
  <tr>
    <td>facebook</td>
    <td>http://www.facebook.com/robots.txt</td>
    <td>https://graph.facebook.com/oauth/access_token</td>
  </tr>
  <tr>
    <td>github</td>
    <td>https://github.com/robots.txt</td>
    <td>https://github.com/login/oauth/access_token</td>
  </tr>
</table>

<h4>Step 1: Copy library</h4>

<p>You will need to copy the <a href="https://github.com/borismus/oauth2-extensions/tree/master/lib">oauth2 library</a> into your chrome extension
root into a directory called <code>oauth2</code>.</p>

<h4>Step 2: Inject content script</h4>

<p>Then you need to modify your manifest.json file to include a content script
at the redirect URL used by the Google adapter. The "matches" redirect URI can
be looked up in the table above:</p>

<pre><code>"content_scripts": [
  {
    "matches": ["http://www.google.com/robots.txt*"],
    "js": ["oauth2/oauth2_inject.js"],
    "run_at": "document_start"
  }
],
</code></pre>

<h4>Step 3: Allow access token URL</h4>

<p>Also, you will need to add a permission to Google's access token granting URL,
since the library will do an XHR against it. The access token URI can be looked
up in the table above as well.</p>

<pre><code>"permissions": [
  "https://accounts.google.com/o/oauth2/token"
]
</code></pre>

<h4>Step 4: Include the OAuth 2.0 library</h4>

<p>Next, in your extension's code, you should include the OAuth 2.0 library:</p>

<pre><code>&lt;script src="/oauth2/oauth2.js"&gt;&lt;/script&gt;
</code></pre>

<h4>Step 5: Configure the OAuth 2.0 endpoint</h4>

<p>And configure your OAuth 2 connection by providing clientId, clientSecret and
apiScopes from the registration page. The authorize() method may create a new
popup window for the user to grant your extension access to the OAuth2
endpoint.</p>

<pre><code>var googleAuth = new OAuth2('google', {
  client_id: '17755888930840',
  client_secret: 'b4a5741bd3d6de6ac591c7b0e279c9f',
  api_scope: 'https://www.googleapis.com/auth/tasks'
});

googleAuth.authorize(function() {
  // Ready for action
});
</code></pre>

<h4>Step 6: Use the access token</h4>

<p>Now that your user has an access token via <code>auth.getAccessToken()</code>, you can
request protected data by adding the accessToken as a request header</p>

<pre><code>xhr.setRequestHeader('Authorization', 'OAuth ' + myAuth.getAccessToken())
</code></pre>

<p>or by passing it as part of the URL (depending on the server implementation):</p>

<pre><code>myUrl + '?oauth_token=' + myAuth.getAccessToken();
</code></pre>

<p><strong>Note</strong>: if you have multiple OAuth 2.0 endpoints that you would like to
authorize with, you can do that too! Just inject content scripts and add
permissions for all of the providers you would like to authorize with.</p>

<p>I've provided <a href="https://github.com/borismus/oauth2-extensions/tree/master/samples">some sample extensions</a> that use this library to help
you get started.</p>

<h2>Varying OAuth implementations</h2>

<p>Writing this library for one OAuth 2.0 endpoint was pretty straightforward.
The issues came when branching out to support multiple OAuth 2.0 server
implementations which comply to various degrees with differing versions of the
spec.</p>

<p>Facebook was the worst offender here. They claim to be an OAuth 2.0
implementation in line with v10, but are actually quite far from it. Here are
some of the issues:</p>

<ul>
<li><p>Token request method is GET instead of POST.</p></li>
<li><p>Token response is some strange form encoded format instead of JSON.</p></li>
<li><p><a href="http://developers.facebook.com/docs/authentication/permissions/">List of scopes</a> (aka "extended permissions") was really hard to
find.</p></li>
<li><p>Apparently to get a user's favorite music, you need the <code>user_likes</code>
permission. Facebook, please <a href="http://forum.developers.facebook.net/viewtopic.php?pid=283691">fix your docs</a>.</p></li>
<li><p>No refresh tokens but they have an offline_access permission which makes your
access token expire later. This is ridiculous!</p></li>
</ul>

<p>Twitter doesn't even have an OAuth 2.0 API. <a href="http://dev.twitter.com/anywhere">@Anywhere</a> does not
count. Some good <a href="http://www.quora.com/Why-isnt-Twitter-implementing-OAuth-2-0-just-like-Facebooks">questions</a> on <a href="http://www.quora.com/When-is-Twitter-going-to-implement-OAuth-2-0">quora</a> about this.</p>

<p>Still there are a lot of services that <em>DO</em> implement OAuth 2.0, such as
Foursquare, Gowalla, Windows Live, Salesforce, Soundcloud and many others.</p>

<h2>Extending the Library</h2>

<p>To mitigate differences between OAuth 2.0 implementations, I implemented the
<a href="http://en.wikipedia.org/wiki/Adapter_pattern">Adapter pattern</a>. Doing this encapsulates protocol differences
in a separate adapter module for each server implementation.</p>

<p>The library comes with adapters for Google, Facebook and Github. These adapters
are located in the <a href="https://github.com/borismus/oauth2-extensions/tree/master/lib/adapters">adapters directory</a> here. If you would like to
contribute your own adapter, please take a look at the sample adapter and then
<a href="https://github.com/borismus/oauth2-extensions">fork the project</a>, submit a pull request, and I'll try to add
it to the project.</p>

<p>Also, please let me know if you experience problems using this library and
we'll sort them out! The best way to do this is via <a href="http://github.com/borismus">github</a> or
<a href="http://twitter.com/borismus">twitter</a>.</p>

    </div>
    <div class='subfooter'>
      <div class='tombstone'>▪</div>
      <time class='published'>July 7, 2011</time>
    </div>
  </article>
</section>


<footer>
  <div>
    © Copyright 2005–2024 Boris Smus.
  </div>
  <nav role="footer">
    <a href='https://smus.com/atom.xml'>RSS</a>
    <a style="display: none" rel="me" href="https://mastodon.social/@borismus">Mastodon</a>
  </nav>
</footer>

<!-- Misc scripts: syntax highlighting, analytics, stats. -->
<script src="/static/js/highlight.pack.js"></script>
<!-- Syntax highlighting for code. -->
<script>
  hljs.tabReplace = '  ';
  hljs.initHighlightingOnLoad();
</script>
<!-- Lightning builder error check. -->
<script src="/lightning_error.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-38Y45XD5VQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-38Y45XD5VQ');
</script>


</body>
</html>