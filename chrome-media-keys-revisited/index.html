<!DOCTYPE html>
<html>
<head>
  <title>Global chrome media keys with Key Socket | Boris Smus</title>

  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0' />

  <meta name="description" content="An extension that lets you bind global keyboard shortcuts to control your favorite music player in chrome." />
  <meta name="author" content="Boris Smus" />
  <link rel="canonical" href="https://smus.com/chrome-media-keys-revisited/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Global chrome media keys with Key Socket" />
  <meta name="twitter:description" content="An extension that lets you bind global keyboard shortcuts to control your favorite music player in chrome." />

  <!-- Facebook -->
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://smus.com/chrome-media-keys-revisited/" />
  <meta property="og:title" content="Global chrome media keys with Key Socket" />
  <meta property="og:description" content="An extension that lets you bind global keyboard shortcuts to control your favorite music player in chrome." />

  <!-- Coil monetization experiment: https://coil.com/settings/monetize -->
  <meta name="monetization" content="$ilp.uphold.com/4Fnyw8KLaPZG">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
  <link rel="manifest" href="/static/icons/site.webmanifest">

  <!-- Styles -->
  <link
  href='//fonts.googleapis.com/css?family=Roboto+Condensed:300|Open+Sans+Condensed:700|Source+Serif+Pro:400,700|Inconsolata' rel='stylesheet' type='text/css'>
  <link rel='stylesheet' href='/static/css/style.css'>
  <link rel='stylesheet' href='/static/css/syntax-highlight.css'>

  <!-- Feed -->
  <link href="https://smus.com/atom.xml" rel="alternate" title="Boris Smus" type="application/atom+xml"/>
</head>
<body>
<header>
  <div id='title'>
    <h1><a href='/'>Boris Smus</a></h1>
    <h2>interaction engineering</h2>
  </div>
  <nav role='navigation'>
    <a href='/about/' >About</a>
    <a href='/blog/' >Blog</a>
    <a href='/clippings/' >Clippings</a>
  </nav>
</header>

<section id='main'>
  <article>
    <a href='/chrome-media-keys-revisited'><h1 class='title'>Global chrome media keys with Key Socket</h1></a>
    <div class='body'>
      <p>I just skipped to the next Google Music track without leaving vim. Wanna play?
Here's the <a href="https://github.com/downloads/borismus/keysocket/KeySocket.zip">app</a> and <a href="https://chrome.google.com/webstore/detail/fphfgdknbpakeedbaenojjdcdoajihik">Chrome extension</a>. To learn how it works, read on!</p>

<h2>Script injection limitations</h2>

<p><a href="/chrome-media-keys">Last time around</a> I implemented keyboard bindings by injecting a content
script into every tab in Chrome, capturing key events and sending them to a
background page. This approach has some serious performance drawbacks:</p>

<ul>
<li>Content scripts injected into each page.</li>
<li>Background pages don't perform very well.</li>
</ul>

<p>And functional limitations:</p>

<ul>
<li>Won't work on special URLs like <code>chrome://</code> and <code>file://</code>.</li>
<li>Won't work when the omnibox is focused.</li>
<li>Requires chrome to be in the foreground.</li>
</ul>

<h2>Global key bindings and websockets</h2>

<p>What we really want is global key bindings. I don't care where my keyboard
focus happens to be right now, I just want to switch to the next freaking song!
This sort of thing requires OS-level event capture, which is functionality most
browsers don't come with. To get around this, I run a standalone app to capture
global keys and run a websocket server to send these events to the browser.
Note that this approach generalizes well to other use cases where functionality
is not available in a browser, but can be more readily implemented natively.</p>

<p>The obvious drawback to this approach is that it requires the user to run a
separate process to capture events.</p>

<h2>Media key bindings in Cocoa and Python</h2>

<p>Rogue Amoeba, maker of some popular OS X audio utilities, has a
<a href="http://rogueamoeba.com/utm/2007/09/29/apple-keyboard-media-key-event-handling/">nice post</a> on their blog on capturing media keys from an OS X
application. The basic idea is to subclass NSApplication and override the
sendEvent: selector:</p>

<pre><code>- (void)sendEvent: (NSEvent*)event {
  if( [event type] == NSSystemDefined &amp;&amp; [event subtype] == 8 ) {
      // Event processing
  }
  [super sendEvent: event];
}
</code></pre>

<p>Which in PyObjC results in the following equivalent code:</p>

<pre><code>def sendEvent_(self, event):
    if event.type() is NSSystemDefined and event.subtype() is 8:
        # Event processing

    NSApplication.sendEvent_(self, event)
</code></pre>

<p>It's pretty neat to be able to implement Cocoa apps without having to write a
single line of objective C. Writing a statusbar app with no dock item was
surprisingly simple (though I have doubts that this works well for Lions and
Tigers and Bears). All that's required is to set <code>LSUIElement</code> to <code>true</code> in the
Info.plist.</p>

<p>To package the whole PyObjC application, I wrote a setup.py script and used
<a href="http://svn.pythonmac.org/py2app/py2app/trunk/doc/index.html">py2app</a>, which generates a Mac OS X .app bundle which, from a user's
perspective is indistinguishable from an OS X app written in Objective C.</p>

<h2>A WebSocket server in python</h2>

<p>In addition to spawning off a Cocoa application and capturing events, of course
I create a WebSocket server. WebSockets use a pretty simple protocol which can
easily be implemented using python sockets. I based my implementation heavily
on <a href="https://gist.github.com/512987">this one</a>.</p>

<p>Since a Cocoa application runs its own event loop which captures the
main thread, the websocket listener needs to run in a separate thread:</p>

<pre><code>class KeySocketServer(Thread):
    def __init__(self):
        self.server = websocket.WebSocketServer('localhost', 1337, KeySocket)
        Thread.__init__(self)

    def run(self):
        self.server.listen()
</code></pre>

<p>The WebSocket standards are still evolving and implementers are, as ever,
scrambling to catch up. The good news is that this means
<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-06#section-4.6">binary support</a> is coming, which is a boon for games and other
intensive network consumers. The bad news is that the latest Chrome canary (at
the time of writing), requires the response to contain the
<code>Sec-WebSocket-Accept</code> header, conforming to the
<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-06">draft-ietf-hybi-thewebsocketprotocol-06</a>, which is incompatible with
the python WebSocket code I'm currently using.</p>

<p>On my wishlist is a robus python WebSockets implementation that supports
multiple versions of the spec while it's still in flux.</p>

<h2>Injected scripts</h2>

<p>On the Chrome extension side, a script is injected into the web player
application, which creates a WebSocket client that connects to the python
server on port 1337. When media keys are pressed, the python server sends
messages to the JS clients and the injected JS simulates DOM events in the web
player application, controlling music playback.</p>

<h2>Try it out</h2>

<p>If you listen to Google Music, thesixtyone or Grooveshark in Chrome on OS X and
want global key bindings, please install the <a href="https://chrome.google.com/webstore/detail/fphfgdknbpakeedbaenojjdcdoajihik">extension</a> and
<a href="https://github.com/downloads/borismus/keysocket/KeySocket.zip">application</a>. If you're feeling generous, contribute your time and love!
I'd gladly take fixes for</p>

<ul>
<li>Key Socket servers for Linux and Windows</li>
<li>Content scripts to control other web audio players</li>
<li>Web Socket implementations that work with the new spec</li>
</ul>

<p>And of course, here's the <a href="https://github.com/borismus/keysocket">source</a>.</p>

    </div>
    <div class='subfooter'>
      <div class='tombstone'>▪</div>
      <time class='published'>July 28, 2011</time>
    </div>
  </article>
</section>


<footer>
  <div>
    © Copyright 2005–2022 Boris Smus.
  </div>
  <nav role="footer">
    <a href='https://smus.com/atom.xml'>RSS</a>

    <!-- Mastodon verification -->
    <a rel="me" href="https://mastodon.social/@borismus" style="display: none">Mastodon</a>
  </nav>
</footer>

<!-- Misc scripts: syntax highlighting, analytics, stats. -->
<script src="/static/js/highlight.pack.js"></script>
<script>
  // Syntax highlighting for code.
  hljs.tabReplace = '  ';
  hljs.initHighlightingOnLoad();
</script>
<script>
  // Google Analytics.
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-17930798-22', 'smus.com');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>
<script src="/lightning_error.js"></script>

</body>
</html>